name: build-artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  windows:
    name: Windows (x86_64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure tag is on master
        run: |
          git fetch --no-tags --prune --depth=1 origin +refs/heads/master:refs/remotes/origin/master
          $sha = (git rev-list -n 1 $env:GITHUB_REF)
          git merge-base --is-ancestor $sha origin/master

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenCV (vcpkg)
        shell: pwsh
        run: |
          vcpkg install opencv4[core,features2d,calib3d,dnn]:x64-windows
          # Expose vcpkg integration for CMake/pkg-config discovery where applicable
          "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append
          "VCPKGRS_DYNAMIC=1" | Out-File -FilePath $env:GITHUB_ENV -Append
          "VCPKGRS_TRIPLET=x64-windows" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install LLVM
        shell: pwsh
        run: |
          choco install llvm -y
          echo "LIBCLANG_PATH=C:\\Program Files\\LLVM\\bin" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build (release)
        run: cargo build --release

      - name: Assemble dist
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/windows/bin | Out-Null
          New-Item -ItemType Directory -Force -Path dist/windows/doc | Out-Null
          Copy-Item -Force target/release/imagestacker.exe dist/windows/bin/
          if (Test-Path USER_MANUAL.md) { Copy-Item -Force USER_MANUAL.md dist/windows/doc/ }
          if (Test-Path README.md) { Copy-Item -Force README.md dist/windows/doc/ }

      - name: Zip
        shell: pwsh
        run: |
          if (Test-Path dist/imagestacker-windows-x86_64.zip) { Remove-Item -Force dist/imagestacker-windows-x86_64.zip }
          Compress-Archive -Path dist/windows/* -DestinationPath dist/imagestacker-windows-x86_64.zip

      - uses: actions/upload-artifact@v4
        with:
          name: imagestacker-windows-x86_64
          path: dist/imagestacker-windows-x86_64.zip

  macos_arm64:
    name: macOS (arm64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Ensure tag is on master
        run: |
          git fetch --no-tags --prune --depth=1 origin +refs/heads/master:refs/remotes/origin/master
          TAG_REF="${GITHUB_REF##*/}"            # Extract just the tag name from GITHUB_REF
          TAG_SHA=$(git rev-list -n 1 "$TAG_REF" 2>/dev/null || echo "")
          if [ -z "$TAG_SHA" ]; then
            echo "ERROR: Unable to resolve tag SHA for $TAG_REF" >&2
            exit 1
          fi
          git merge-base --is-ancestor "$TAG_SHA" origin/master || { echo "ERROR: Tag $TAG_REF ($TAG_SHA) is not an ancestor of origin/master"; exit 1; }

      - name: Install dependencies (Homebrew)
        run: |
          brew update
          brew install opencv pkg-config llvm
          # Help pkg-config find Homebrew OpenCV
          echo "PKG_CONFIG_PATH=$(brew --prefix)/lib/pkgconfig:$(brew --prefix opencv)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      - name: Set LLVM environment variables
        run: |
          echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> $GITHUB_ENV
          echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build .app + zip
        run: |
          chmod +x packaging/macos/build.sh
          ./packaging/macos/build.sh

      - uses: actions/upload-artifact@v4
        with:
          name: imagestacker-macos-arm64
          path: dist/imagestacker-macos-arm64.zip

  linux_rpm:
    name: Linux RPM (openSUSE Tumbleweed)
    runs-on: ubuntu-latest
    container:
      image: opensuse/tumbleweed:latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git
        run: |
          zypper --non-interactive install -y git

      - name: Ensure tag is on master
        run: |
          cd "$GITHUB_WORKSPACE"
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          if [ ! -d .git ]; then
            echo "ERROR: .git not found in $PWD" >&2
            ls -la
            exit 2
          fi
          git fetch --no-tags --prune --depth=1 origin +refs/heads/master:refs/remotes/origin/master
          TAG_REF="${GITHUB_REF##*/}"            # Extract just the tag name from GITHUB_REF
          TAG_SHA=$(git rev-list -n 1 "$TAG_REF" 2>/dev/null || echo "")
          if [ -z "$TAG_SHA" ]; then
            echo "ERROR: Unable to resolve tag SHA for $TAG_REF" >&2
            exit 1
          fi
          git merge-base --is-ancestor "$TAG_SHA" origin/master || { echo "ERROR: Tag $TAG_REF ($TAG_SHA) is not an ancestor of origin/master"; exit 1; }

      - name: Install dependencies (zypper)
        run: |
          zypper --non-interactive ref
          zypper --non-interactive install -y \
            rpm-build rpmdevtools \
            gcc gcc-c++ cmake pkgconf-pkg-config \
            opencv-devel gtk3-devel ImageMagick \
            curl tar gzip

      - name: Verify OpenCV via pkg-config
        run: |
          pkg-config --modversion opencv4

      - name: Install Rust (rustup)
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source "$HOME/.cargo/env"
          rustup toolchain install stable
          rustup default stable

      - name: Build RPM
        run: |
          source "$HOME/.cargo/env"
          chmod +x packaging/linux/build-rpm.sh
          packaging/linux/build-rpm.sh

      - name: Collect RPM artifacts
        run: |
          mkdir -p dist/rpm
          find "$HOME/rpmbuild/RPMS" -name 'imagestacker-*.rpm' -maxdepth 3 -type f -print -exec cp -v {} dist/rpm/ \;
          find "$HOME/rpmbuild/SRPMS" -name 'imagestacker-*.src.rpm' -maxdepth 2 -type f -print -exec cp -v {} dist/rpm/ \;

      - uses: actions/upload-artifact@v4
        with:
          name: imagestacker-rpm
          path: dist/rpm/

  release:
    name: Create/Update GitHub Release
    runs-on: ubuntu-latest
    needs: [windows, macos_arm64, linux_rpm]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-artifacts

      - name: Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist-artifacts/**/imagestacker-*.zip
            dist-artifacts/**/imagestacker-*.rpm
            dist-artifacts/**/imagestacker-*.src.rpm
